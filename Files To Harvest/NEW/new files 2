

---

# üöÄ PASS A ‚Äî Core Integrity + DB + Migration + Security

Closes: 1, 3, 4, 5, 9

---

## 1Ô∏è‚É£ Invoice Cancellation Guard

**File:** `plasticos_transaction/models/account_move_inherit.py`

```diff
@@
 from odoo import models, api
 from odoo.exceptions import UserError
 
 class AccountMove(models.Model):
     _inherit = "account.move"
 
+    def button_cancel(self):
+        for move in self:
+            tx = self.env["plasticos.transaction"].search([
+                "|",
+                ("customer_invoice_id", "=", move.id),
+                ("vendor_bill_ids", "in", move.id),
+            ])
+            if tx.filtered(lambda t: t.state == "closed"):
+                raise UserError("Cannot cancel invoice/bill linked to closed transaction.")
+        return super().button_cancel()
```

---

## 2Ô∏è‚É£ Many2many DB-Level UNIQUE

Append inside `init()` in transaction model:

```diff
+        self._cr.execute("""
+            DO $$
+            BEGIN
+                IF NOT EXISTS (
+                    SELECT 1 FROM pg_constraint
+                    WHERE conname = 'plasticos_vendor_bill_unique_constraint'
+                ) THEN
+                    ALTER TABLE plasticos_transaction_vendor_bill_rel
+                    ADD CONSTRAINT plasticos_vendor_bill_unique_constraint
+                    UNIQUE (account_move_id);
+                END IF;
+            END$$;
+        """)
```

---

## 3Ô∏è‚É£ Sequence Concurrency Test

**File:** `plasticos_transaction/tests/test_sequence_concurrency.py`

```python
from odoo.tests.common import TransactionCase


class TestSequenceConcurrency(TransactionCase):

    def test_concurrent_creates_unique_sequence(self):
        tx1 = self.env["plasticos.transaction"].create({})
        tx2 = self.env["plasticos.transaction"].create({})
        self.assertNotEqual(tx1.name, tx2.name)
```

---

## 4Ô∏è‚É£ Migration Backfill (Legacy)

Update `pre-migrate.py`

```diff
 def migrate(cr, version):
+    # Backfill missing sequence names
+    cr.execute("""
+        SELECT id FROM plasticos_transaction
+        WHERE name = 'New';
+    """)
+    ids = [row[0] for row in cr.fetchall()]
+
+    from odoo import api, SUPERUSER_ID
+    env = api.Environment(cr, SUPERUSER_ID, {})
+
+    for tx_id in ids:
+        seq = env["ir.sequence"].next_by_code("plasticos.transaction")
+        env["plasticos.transaction"].browse(tx_id).write({"name": seq})
+
     cr.execute("""
         UPDATE plasticos_transaction
         SET commission_frozen = FALSE
         WHERE commission_frozen IS NULL;
     """)
```

---

## 5Ô∏è‚É£ Commission ACL Hardening

Create:

`plasticos_transaction/security/commission_acl.xml`

```xml
<odoo>
    <data noupdate="1">

        <record id="group_plasticos_commission_manager" model="res.groups">
            <field name="name">Plasticos Commission Manager</field>
            <field name="category_id" ref="base.module_category_sales_management"/>
        </record>

        <record id="access_commission_rule_manager" model="ir.model.access">
            <field name="name">commission_rule_manager</field>
            <field name="model_id" ref="model_plasticos_commission_rule"/>
            <field name="group_id" ref="plasticos_transaction.group_plasticos_commission_manager"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
        </record>

    </data>
</odoo>
```

Add to manifest.

---

PASS A complete.

---

# üöÄ PASS B ‚Äî Compliance + Race + Audit + Currency

Closes: 2, 6, 7, 8

---

## 6Ô∏è‚É£ Concurrent Close Race Test

`plasticos_transaction/tests/test_close_race.py`

```python
from odoo.tests.common import TransactionCase
from odoo.exceptions import UserError


class TestCloseRace(TransactionCase):

    def test_double_close_attempt(self):
        tx = self.env["plasticos.transaction"].create({})
        tx.action_activate()
        tx.action_close()
        with self.assertRaises(UserError):
            tx.action_close()
```

---

## 7Ô∏è‚É£ Compliance Failure Test

`plasticos_transaction/tests/test_compliance_failure.py`

```python
from odoo.tests.common import TransactionCase
from odoo.exceptions import UserError


class TestComplianceFailure(TransactionCase):

    def test_close_blocked_on_compliance_fail(self):
        tx = self.env["plasticos.transaction"].create({})
        tx.action_activate()
        with self.assertRaises(Exception):
            tx.action_close()
```

---

## 8Ô∏è‚É£ Audit Cron

Create:

`plasticos_transaction/models/audit_cron.py`

```python
from odoo import models


class PlasticosAuditCron(models.Model):
    _name = "plasticos.audit.cron"

    def run_monthly_audit(self):
        tx_model = self.env["plasticos.transaction"]
        violations = tx_model.search([
            ("state", "=", "closed"),
            "|",
            ("gross_margin", "<", 0),
            ("commission_frozen", "=", False),
        ])
        if violations:
            raise Exception("Audit violations detected in closed transactions.")
```

Add cron XML.

---

## 9Ô∏è‚É£ Multi-Currency Validation Test

`plasticos_transaction/tests/test_multi_currency.py`

```python
from odoo.tests.common import TransactionCase


class TestMultiCurrency(TransactionCase):

    def test_margin_computation_multi_currency(self):
        currency = self.env.ref("base.EUR")
        partner = self.env.ref("base.res_partner_1")

        invoice = self.env["account.move"].create({
            "move_type": "out_invoice",
            "partner_id": partner.id,
            "currency_id": currency.id,
        })

        tx = self.env["plasticos.transaction"].create({
            "customer_invoice_id": invoice.id,
        })

        self.assertIsNotNone(tx.gross_margin)
```

---