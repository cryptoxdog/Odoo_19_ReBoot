
---

# 1Ô∏è‚É£ ADD ‚Äî Sequence XML

**File:**
`plasticos_transaction/data/sequence.xml`

```diff
+<?xml version="1.0" encoding="UTF-8"?>
+<odoo>
+    <data noupdate="1">
+
+        <record id="seq_plasticos_transaction" model="ir.sequence">
+            <field name="name">Plasticos Transaction</field>
+            <field name="code">plasticos.transaction</field>
+            <field name="prefix">TRX-%(year)s-</field>
+            <field name="padding">6</field>
+            <field name="implementation">no_gap</field>
+            <field name="company_id" eval="False"/>
+        </record>
+
+    </data>
+</odoo>
```

---

# 2Ô∏è‚É£ MODIFY ‚Äî Manifest (Add Data File)

**File:**
`plasticos_transaction/__manifest__.py`

Add inside `"data": [...]` section:

```diff
+        "data/sequence.xml",
```

Place after existing data entries. No removal.

---

# 3Ô∏è‚É£ MODIFY ‚Äî Transaction Model

**File:**
`plasticos_transaction/models/transaction.py`

### ‚ûï Add SQL Constraint

Add inside class:

```diff
+    _sql_constraints = [
+        (
+            "unique_transaction_name",
+            "unique(name)",
+            "Transaction reference must be unique."
+        ),
+    ]
```

---

### ‚ûï Add create() Override

Add below fields (inside class):

```diff
+    @api.model
+    def create(self, vals):
+        if vals.get("name", "New") == "New":
+            vals["name"] = self.env["ir.sequence"].next_by_code(
+                "plasticos.transaction"
+            ) or "New"
+        return super().create(vals)
```

---

### ‚ûï Add write() Guard for Name Immutability

Add inside class:

```diff
+    def write(self, vals):
+        if "name" in vals:
+            raise UserError("Transaction reference cannot be modified.")
+        return super().write(vals)
```

---

# üß± 1Ô∏è‚É£ EXTEND `transaction.py`

**File:**
`plasticos_transaction/models/transaction.py`

---

## ‚ûï ADD ‚Äî Freeze Fields

```diff
+    commission_frozen = fields.Boolean(default=False, copy=False)
+    commission_frozen_amount = fields.Float(copy=False)
+    commission_frozen_at = fields.Datetime(copy=False)
```

---

## ‚ûï MODIFY ‚Äî Financial Compute (Respect Freeze)

Inside `_compute_financials`, replace commission logic block only:

```diff
-            if rec.commission_override_flat:
-                commission = rec.commission_override_flat
-            elif rec.commission_rule_id:
-                commission = gross * rec.commission_rule_id.percentage
-            else:
-                commission = 0.0
+            if rec.commission_frozen:
+                commission = rec.commission_frozen_amount
+            else:
+                if rec.commission_override_flat is not False and rec.commission_override_flat is not None:
+                    commission = rec.commission_override_flat
+                elif rec.commission_rule_id:
+                    commission = gross * rec.commission_rule_id.percentage
+                else:
+                    commission = 0.0
```

---

## ‚ûï MODIFY ‚Äî action_close()

Extend existing method (append before setting state):

```diff
     def action_close(self):
         for rec in self:
             if not rec.customer_invoice_id or rec.customer_invoice_id.state != "posted":
                 raise UserError("Customer invoice must be posted.")

             if any(bill.state != "posted" for bill in rec.vendor_bill_ids):
                 raise UserError("All vendor bills must be posted.")

             if rec.linda_load_id and rec.linda_load_id.state != "closed":
                 raise UserError("Logistics must be closed.")
+
+            # Compliance Gate
+            compliance_service = self.env["plasticos.document"].sudo()
+            if hasattr(compliance_service, "check_transaction_compliance"):
+                compliance_service.check_transaction_compliance(rec)
+
+            # Prevent negative margin close
+            if rec.gross_margin < 0:
+                raise UserError("Cannot close transaction with negative gross margin.")
+
+            # Freeze commission
+            rec.commission_frozen = True
+            rec.commission_frozen_amount = rec.commission_amount
+            rec.commission_frozen_at = fields.Datetime.now()

             rec.state = "closed"
```

---

## ‚ûï MODIFY ‚Äî write() Guard

Replace existing write() with lifecycle-safe version:

```diff
     def write(self, vals):
-        if "name" in vals:
-            raise UserError("Transaction reference cannot be modified.")
-        return super().write(vals)
+        for rec in self:
+            # Block direct state mutation
+            if "state" in vals:
+                raise UserError("State can only be changed via action methods.")
+
+            # Immutable identity
+            if "name" in vals:
+                raise UserError("Transaction reference cannot be modified.")
+
+            # Closed transaction lock
+            if rec.state == "closed":
+                protected_fields = {
+                    "sale_order_id",
+                    "purchase_order_ids",
+                    "customer_invoice_id",
+                    "vendor_bill_ids",
+                    "freight_bill_ids",
+                    "commission_rule_id",
+                    "commission_override_flat",
+                }
+                if protected_fields.intersection(vals.keys()):
+                    raise UserError("Closed transactions are immutable.")
+
+        return super().write(vals)
```

---

# üß± 2Ô∏è‚É£ ADD ‚Äî Idempotent Linking Constraints

## ‚ûï ADD SQL Constraints

Inside class:

```diff
+    _sql_constraints += [
+        (
+            "unique_customer_invoice_link",
+            "unique(customer_invoice_id)",
+            "Customer invoice is already linked to another transaction."
+        ),
+    ]
```

---

## ‚ûï ADD Python-Level Guard (Vendor/Freight Bills)

Append inside `write()` before super():

```diff
+            if "vendor_bill_ids" in vals:
+                for bill in self.env["account.move"].browse(vals.get("vendor_bill_ids", [])):
+                    existing = self.search([
+                        ("vendor_bill_ids", "in", bill.id),
+                        ("id", "!=", rec.id),
+                    ])
+                    if existing:
+                        raise UserError("Vendor bill already linked to another transaction.")
+
+            if "freight_bill_ids" in vals:
+                for bill in self.env["account.move"].browse(vals.get("freight_bill_ids", [])):
+                    existing = self.search([
+                        ("freight_bill_ids", "in", bill.id),
+                        ("id", "!=", rec.id),
+                    ])
+                    if existing:
+                        raise UserError("Freight bill already linked to another transaction.")
```

---

# üß± 3Ô∏è‚É£ ADD ‚Äî Negative Margin SQL Safety Net

Append:

```diff
+    _sql_constraints += [
+        (
+            "non_negative_margin_on_close",
+            "CHECK(state != 'closed' OR gross_margin >= 0)",
+            "Closed transactions cannot have negative gross margin."
+        ),
+    ]
```

---

# üß± 4Ô∏è‚É£ ADD ‚Äî Commission Override Integrity

Append inside write() guard:

```diff
+            if rec.commission_frozen and "commission_override_flat" in vals:
+                raise UserError("Commission override cannot be modified after freeze.")
```

---

# üß± 5Ô∏è‚É£ ADD ‚Äî Direct Invoice Reassignment Guard

Append inside write():

```diff
+            if rec.customer_invoice_id and "customer_invoice_id" in vals:
+                raise UserError("Customer invoice cannot be reassigned once set.")
```

---

# üß± 6Ô∏è‚É£ ADD ‚Äî Many2many Relation Table Unique Constraint

Add in model init section (top of class):

```diff
+    def init(self):
+        self._cr.execute("""
+            CREATE UNIQUE INDEX IF NOT EXISTS
+            plasticos_vendor_bill_unique
+            ON plasticos_transaction_vendor_bill_rel (account_move_id);
+        """)
+
+        self._cr.execute("""
+            CREATE UNIQUE INDEX IF NOT EXISTS
+            plasticos_freight_bill_unique
+            ON plasticos_transaction_freight_bill_rel (account_move_id);
+        """)
```

---

# 1Ô∏è‚É£ `plasticos_transaction/models/transaction.py` ‚Äî Performance Indexes

Append inside class:

```diff
+    def init(self):
+        self._cr.execute("""
+            CREATE INDEX IF NOT EXISTS plasticos_tx_state_idx
+            ON plasticos_transaction (state);
+        """)
+
+        self._cr.execute("""
+            CREATE INDEX IF NOT EXISTS plasticos_tx_sale_idx
+            ON plasticos_transaction (sale_order_id);
+        """)
+
+        self._cr.execute("""
+            CREATE INDEX IF NOT EXISTS plasticos_tx_invoice_idx
+            ON plasticos_transaction (customer_invoice_id);
+        """)
+
+        self._cr.execute("""
+            CREATE INDEX IF NOT EXISTS plasticos_tx_commission_frozen_idx
+            ON plasticos_transaction (commission_frozen);
+        """)
+
+        self._cr.execute("""
+            CREATE INDEX IF NOT EXISTS plasticos_tx_margin_idx
+            ON plasticos_transaction (gross_margin);
+        """)
```

---

# 3Ô∏è‚É£ Deletion & Unlink Guard

## Append inside `transaction.py`

```diff
+    def unlink(self):
+        for rec in self:
+            if rec.state == "closed":
+                raise UserError("Closed transactions cannot be deleted.")
+        return super().unlink()
```

---
